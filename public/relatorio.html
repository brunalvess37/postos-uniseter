<!DOCTYPE html>
<html lang="pt-BR">
<head>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Gerar Relat√≥rio ‚Äî Postos UNISETER</title>

<script async crossorigin="anonymous"
  src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
  data-clerk-publishable-key="pk_test_bHVja3ktc3RpbmtidWctODUuY2xlcmsuYWNjb3VudHMuZGV2JA">
</script>

<link rel="stylesheet" href="style.css?v=202501">

<style>
body{ display:none; padding:20px; }
.container{ max-width:640px; margin:auto; }

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:16px;
  margin-bottom:16px;
}

label{ font-weight:bold; display:block; margin:8px 0 4px; }
.radio-group label{ font-weight:normal; }

button{
  padding:10px 16px;
  border-radius:8px;
  cursor:pointer;
}

.primary{
  background:var(--primary);
  color:white;
  border:none;
  width:100%;
}

.secondary{
  background:transparent;
  border:1px solid var(--border);
  width:100%;
}

.hidden{ display:none; }
</style>

</head>

<body>

<script>
let usuarioRelatorio = null;

document.addEventListener("DOMContentLoaded", async ()=>{

  const c = window.Clerk;
  await c.load();

  if(!c.user) return location.href="/signin.html";

  usuarioRelatorio = {
    nome: c.user.fullName || "",
    email: c.user.primaryEmailAddress
      ? c.user.primaryEmailAddress.emailAddress
      : ""
  };

  document.body.style.display="block";

// üîπ NOVO: se j√° houver sele√ß√£o salva, pr√©-seleciona "manual"
if (localStorage.getItem("postos_selecionados")) {
  const radioManual = document.querySelector('input[name="tipo"][value="manual"]');
  if (radioManual) radioManual.checked = true;
}

atualizarEstadoBotoes();
});


function atualizarEstadoBotoes(){
  const tipo = document.querySelector("input[name=tipo]:checked").value;

  const temSelecao = !!localStorage.getItem("postos_selecionados");

  // S√≥ desabilita se for manual E ainda n√£o houver sele√ß√£o
  document.getElementById("btnGerar").disabled =
    (tipo === "manual" && !temSelecao);


  // Mostra o bot√£o inline abaixo de "Sele√ß√£o manual"
document.getElementById("btnManualInline")
  .classList.toggle("hidden", tipo !== "manual");

// Mostra/oculta o texto de status da sele√ß√£o
const status = document.getElementById("manualStatus");

if (tipo === "manual" && temSelecao) {
  status.classList.remove("hidden");
} else {
  status.classList.add("hidden");
}
}

  
</script>

<div class="container">

<header>
  <h2>Gerar Relat√≥rio</h2>
  <button type="button" onclick="location.href='home.html'">‚Üê Menu</button>
</header>

<p style="color:var(--muted)">Defina os crit√©rios do relat√≥rio</p>

<div class="card">
  <label>Tipo de relat√≥rio</label>
  <div class="radio-group" onchange="atualizarEstadoBotoes()">

    <label>
      <input type="radio" name="tipo" value="ativos" checked>
      Postos ativos
    </label>

    <label>
      <input type="radio" name="tipo" value="todos">
      Todos os cadastros (ativos + inativos)
    </label>

    <label>
      <input type="radio" name="tipo" value="favoritos">
      Apenas favoritos
    </label>

    <label>
  <input type="radio" name="tipo" value="manual">
  Sele√ß√£o manual
</label>

<button
  id="btnManualInline"
  type="button"
  class="secondary hidden"
  style="margin: 8px 0 0 24px; width: auto;"
  onclick="location.href='relatorio-selecao.html'">
  Selecionar postos
</button>

<p id="manualStatus"
   class="hidden"
   style="margin: 6px 0 0 24px; color: var(--muted); font-size: 13px;">
  ‚úîÔ∏è Sele√ß√£o manual ativa ‚Äî clique em ‚ÄúGerar PDF‚Äù
</p>

    </div>
</div>

<div class="card">
  <label style="display:flex; align-items:center; gap:6px;">
    <input type="checkbox" id="incluirIndice">
    Incluir p√°gina de √≠ndice no relat√≥rio
  </label>
</div>

<div class="card">
  <label>Ordena√ß√£o</label>

  <div class="radio-group">
    <label>
      <input type="radio" name="ordem" value="posto" checked>
      Nome do Posto
    </label>
    <label>
      <input type="radio" name="ordem" value="cidade">
      Cidade
    </label>
    <label>
      <input type="radio" name="ordem" value="zona">
      Zona
    </label>
  </div>
</div>

<div class="card">
  <button
    id="btnGerar"
    type="button"
    class="primary"
    onclick="gerar()">
    Gerar PDF
  </button>

</div>

</div>

<!-- DEPEND√äNCIAS DO PDF -->
<script src="pdfmake.min.js?v=202501"></script>
<script src="vfs_fonts.js?v=202501"></script>

<!-- PDF -->
<script src="pdf-geral.js?v=202501"></script>

<script>
function gerar(){
  gerarPDFGeral({
    tipo: document.querySelector("input[name=tipo]:checked").value,
    ordem: document.querySelector("input[name=ordem]:checked").value,
    usuario: usuarioRelatorio,
    incluirIndice: document.getElementById("incluirIndice").checked
  });
}
</script>

</body>
</html>
