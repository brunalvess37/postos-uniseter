<!DOCTYPE html>
<html lang="pt-BR">
<head>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Gerar Relatório — Postos UNISETER</title>

<script async crossorigin="anonymous"
src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
data-clerk-publishable-key="pk_test_bHVja3ktc3RpbmtidWctODUuY2xlcmsuYWNjb3VudHMuZGV2JA"></script>

<link rel="stylesheet" href="style.css?v=202501">

<style>
body{ display:none; font-family:Arial; padding:20px; }
.container{ max-width:600px; margin:auto; }
.card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; }
label{ font-weight:bold; display:block; margin:8px 0 4px; }
button{ padding:10px 14px; border-radius:8px; cursor:pointer; }
.primary{ background:var(--primary); color:white; border:none; }

.lista-postos{
  max-height:260px;
  overflow:auto;
  border:1px solid var(--border);
  border-radius:8px;
  padding:8px;
  display:none;
}
.lista-postos label{
  font-weight:normal;
  display:flex;
  gap:6px;
  margin:4px 0;
}
</style>

</head>

<body>

<script>
document.addEventListener("DOMContentLoaded", async ()=>{
  const c = window.Clerk;
  await c.load();
  if(!c.user) return location.href="/signin.html";
  document.body.style.display="block";
});
</script>

<div class="container">

<h2>Gerar Relatório</h2>
<p style="color:var(--muted)">Escolha os filtros do relatório</p>

<div class="card">
  <label>Tipo</label>
  <label><input type="radio" name="tipo" value="todos" checked> Todos os postos</label>
  <label><input type="radio" name="tipo" value="favoritos"> Apenas favoritos</label>
  <label><input type="radio" name="tipo" value="manual"> Seleção manual</label>
</div>

<div class="card" id="card-manual">
  <label>Selecione os postos</label>
  <div class="lista-postos" id="listaPostos"></div>
</div>

<div class="card">
  <label>Cidade</label>
  <select id="cidade"><option value="">Todas</option></select>

  <label>Zona</label>
  <select id="zona"><option value="">Todas</option></select>
</div>

<div class="card">
  <label>Ordenação</label>
  <label><input type="radio" name="ordem" value="cidade-zona" checked> Cidade + Zona</label>
  <label><input type="radio" name="ordem" value="cidade-posto"> Cidade + Nome</label>
  <label><input type="radio" name="ordem" value="posto"> Nome do Posto</label>
</div>

<div class="card" style="text-align:center">
  <button class="primary" onclick="gerar()">Gerar PDF</button>
</div>

<button onclick="location.href='home.html'">← Voltar ao menu</button>

</div>

<script src="pdf-geral.js?v=202501"></script>

<script>
let todosPostos = [];

async function carregarFiltros(){
  todosPostos = await fetch("/api/postos").then(r=>r.json());

  [...new Set(todosPostos.map(p=>p.CIDADE).filter(Boolean))].sort()
    .forEach(v=>cidade.add(new Option(v,v)));

  [...new Set(todosPostos.map(p=>p.ZONA).filter(Boolean))].sort()
    .forEach(v=>zona.add(new Option(v,v)));

  const lista = document.getElementById("listaPostos");
  lista.innerHTML = todosPostos.map((p,i)=>`
    <label>
      <input type="checkbox" value="${i}">
      ${p["POSTOS DE SERVIÇOS / GRUPO SETER"]} — ${p.CIDADE || ""}
    </label>
  `).join("");
}

document.querySelectorAll("input[name=tipo]").forEach(r=>{
  r.addEventListener("change", ()=>{
    const manual = document.querySelector("input[name=tipo]:checked").value === "manual";
    document.getElementById("listaPostos").style.display = manual ? "block" : "none";
  });
});

function gerar(){
  const tipo = document.querySelector("input[name=tipo]:checked").value;

  let selecionados = [];
  if(tipo === "manual"){
    selecionados = [...document.querySelectorAll("#listaPostos input:checked")]
      .map(i=>Number(i.value));
  }

  gerarPDFGeral({
    tipo,
    cidade: cidade.value,
    zona: zona.value,
    ordem: document.querySelector("input[name=ordem]:checked").value,
    selecionados
  });
}

carregarFiltros();
</script>

</body>
</html>
