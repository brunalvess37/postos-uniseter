<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Mapa ‚Äî Postos UNISETER</title>

  <script async crossorigin="anonymous"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
    data-clerk-publishable-key="pk_test_bHVja3ktc3RpbmtidWctODUuY2xlcmsuYWNjb3VudHMuZGV2JA">
  </script>

  <link rel="stylesheet" href="style.css?v=202501">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body{display:none;padding:20px;}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
    #map{width:100%;height:calc(100vh - 200px);border-radius:12px;border:1px solid var(--border);}
  </style>
</head>

<body>

<script>
document.addEventListener("DOMContentLoaded", async ()=>{
  await Clerk.load();
  if(!Clerk.user) return location.href="/signin.html";
  document.body.style.display="block";
  initMapa();
});
</script>

<header>
  <h2 style="margin:0;">Mapa</h2>
  <button onclick="location.href='app.html'">‚Üê Voltar</button>
</header>

<div id="map"></div>

<script>
async function initMapa(){

  const map = L.map("map",{ zoomControl:false }).setView([-22.905,-47.060],10);
  L.control.zoom({ position:"topright" }).addTo(map);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  const postos = await fetch("/api/postos").then(r=>r.json());
  const markers = [];

  const zonas = [...new Set(postos.map(p=>p.ZONA).filter(Boolean))];
  const cores = {};
  zonas.forEach((z,i)=>cores[z]=`hsl(${(i*360)/zonas.length},70%,45%)`);

  function icon(cor,ativo=false){
    return L.divIcon({
      html:`<div style="
        background:${cor};
        width:${ativo?18:12}px;
        height:${ativo?18:12}px;
        border-radius:50%;
        opacity:${ativo?1:0.6};
        border:2px solid white;
      "></div>`
    });
  }

  postos.forEach((p,i)=>{
    if(!p.Latitude||!p.Longitude) return;

    const popup = `
      <b>${p["POSTOS DE SERVI√áOS / GRUPO SETER"]}</b><br>
      ${p.CIDADE}
    `;

    const m = L.marker(
      [p.Latitude,p.Longitude],
      { icon: icon(cores[p.ZONA]||"#555") }
    ).addTo(map).bindPopup(popup);

    markers.push(m);
  });

  // ===============================
  // üß≠ BOT√ÉO VER ROTA (TOGGLE CORRETO)
  // ===============================
  let rotaAtiva = false;
  let rotaLine = null;

  window.toggleRota = function(){
    rotaAtiva = !rotaAtiva;

    if(!rotaAtiva){
      if(rotaLine){
        map.removeLayer(rotaLine);
        rotaLine = null;
      }
      return;
    }

    const dados = JSON.parse(localStorage.getItem("rota_postos")||"{}").rota || [];
    if(!dados.length){
      alert("Nenhum posto na rota.");
      rotaAtiva = false;
      return;
    }

    const latlngs = dados.map(p=>[p.Latitude,p.Longitude]);
    rotaLine = L.polyline(latlngs,{
      color:"#003c8d",
      weight:4,
      opacity:0.9
    }).addTo(map);

    map.fitBounds(rotaLine.getBounds(),{padding:[40,40]});
  }
}
</script>

<!-- bot√£o simples s√≥ para teste -->
<button onclick="toggleRota()" style="margin-top:12px;">üß≠ Ver rota</button>

</body>
</html>
