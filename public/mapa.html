<!DOCTYPE html>
<html lang="pt-BR">
<head>

  <!-- üî• Anti-cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Mapa ‚Äî Postos UNISETER</title>

  <!-- üîê Clerk -->
  <script async crossorigin="anonymous"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
    data-clerk-publishable-key="pk_test_bHVja3ktc3RpbmtidWctODUuY2xlcmsuYWNjb3VudHMuZGV2JA">
  </script>

  <!-- üé® CSS global -->
  <link rel="stylesheet" href="style.css?v=202501">

  <!-- üó∫Ô∏è Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body{ display:none; padding:20px; }
    header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }

    #controls{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    #search{
      padding:8px;
      border-radius:8px;
      border:1px solid var(--border);
      width:260px;
    }

    #zonas{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      font-size:13px;
    }

    #map{
      width:100%;
      height:calc(100vh - 200px);
      border-radius:12px;
      border:1px solid var(--border);
    }

    .popup-title{ font-weight:bold; color:#003c8d; }
    .popup-address{ font-size:12px; margin:4px 0 8px; }

    .popup-actions button{
      margin-right:6px;
      padding:5px 8px;
      font-size:12px;
      border-radius:6px;
      border:1px solid #003c8d;
      cursor:pointer;
    }
  </style>

</head>

<body>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const c = window.Clerk;
  await c.load();
  if(!c.user) return location.href="/signin.html";
  document.body.style.display="block";
  initMapa();
});
</script>

<header>
  <h2 style="margin:0;">Mapa</h2>
  <button onclick="location.href='app.html'">‚Üê Voltar</button>
</header>

<div id="controls">
  <input id="search" placeholder="Buscar por nome, bairro ou cidade">
  <div id="zonas"></div>
</div>

<div id="map"></div>

<script>
async function initMapa(){

  const map = L.map("map").setView([-22.905, -47.060], 10);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  const postos = await fetch("/api/postos").then(r=>r.json());
  const rotaAtual = JSON.parse(localStorage.getItem("rota_postos")||"{}").rota || [];

  const zonas = [...new Set(postos.map(p=>p.ZONA).filter(Boolean))];
  const cores = {};
  zonas.forEach((z,i)=> cores[z] = `hsl(${i*47%360},70%,45%)`);

  const markers = [];

  function icon(zona, destaque=false){
    return L.divIcon({
      html:`<div style="
        width:${destaque?20:14}px;
        height:${destaque?20:14}px;
        border-radius:50%;
        background:${cores[zona]||"#666"};
        border:${destaque?"4px solid black":"2px solid white"};
      "></div>`
    });
  }

  postos.forEach((p,i)=>{
    if(!p.Latitude || !p.Longitude) return;

    const endereco = [
      p["ENDERE√áO I"],p["ENDERE√áO II"],p["ENDERE√áO III"],p["ENDERE√áO IV"],p.CIDADE
    ].filter(Boolean).join(" - ");

    const popup = `
      <div>
        <div class="popup-title">${p["POSTOS DE SERVI√áOS / GRUPO SETER"]}</div>
        <div class="popup-address">${endereco}</div>
        <div class="popup-actions">
          <button onclick="addRota(${i})">‚ûï Rota</button>
          <button onclick="window.open('https://maps.google.com/?q=${p.Latitude},${p.Longitude}')">Google</button>
          <button onclick="window.open('https://waze.com/ul?ll=${p.Latitude},${p.Longitude}&navigate=yes')">Waze</button>
        </div>
      </div>
    `;

    const marker = L.marker([p.Latitude,p.Longitude],{
      icon:icon(p.ZONA)
    }).addTo(map).bindPopup(popup);

    markers.push({marker,posto:p,zona:p.ZONA});
  });

  document.getElementById("search").oninput = e=>{
    const q = e.target.value.toLowerCase().trim();

    markers.forEach(m=>{
      const p = m.posto;
      const match =
        p["POSTOS DE SERVI√áOS / GRUPO SETER"]?.toLowerCase().includes(q) ||
        p["ENDERE√áO III"]?.toLowerCase().includes(q) ||
        p.CIDADE?.toLowerCase().includes(q);

      if(!q){
        m.marker.setOpacity(1);
        m.marker.setIcon(icon(m.zona));
        return;
      }

      if(match){
        m.marker.setOpacity(1);
        m.marker.setIcon(icon(m.zona,true));
        map.setView(m.marker.getLatLng(),13);
        m.marker.openPopup();
      }else{
        m.marker.setOpacity(0.65);
        m.marker.setIcon(icon(m.zona));
      }
    });
  };
}

function addRota(i){
  fetch("/api/postos").then(r=>r.json()).then(postos=>{
    const dados = JSON.parse(localStorage.getItem("rota_postos")||"{}");
    const rota = dados.rota||[];
    rota.push(postos[i]);
    localStorage.setItem("rota_postos",JSON.stringify({
      rota,
      data:new Date().toLocaleString("pt-BR")
    }));
    alert("Posto adicionado √† rota!");
  });
}
</script>

</body>
</html>
