<!DOCTYPE html>
<html lang="pt-BR">
<head>

  <!-- üî• Anti-cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Mapa ‚Äî Postos UNISETER</title>

  <!-- üîê Clerk -->
  <script async crossorigin="anonymous"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
    data-clerk-publishable-key="pk_test_bHVja3ktc3RpbmtidWctODUuY2xlcmsuYWNjb3VudHMuZGV2JA">
  </script>

  <!-- üé® CSS global -->
  <link rel="stylesheet" href="style.css?v=202501">

  <!-- üó∫Ô∏è Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body{ display:none; padding:20px; }

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }

    #map{
      width:100%;
      height:calc(100vh - 200px);
      border-radius:12px;
      border:1px solid var(--border);
    }

    .search-box{
      max-width:520px;
      margin:0 auto 12px;
      position:relative;
      z-index:1100;
    }

    #search{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:2px solid #003c8d;
      font-size:15px;
    }

    #suggestions{
      position:absolute;
      width:100%;
      background:white;
      border-radius:8px;
      box-shadow:0 4px 10px rgba(0,0,0,.15);
      max-height:260px;
      overflow:auto;
    }

    .suggestion-card{
      padding:8px 10px;
      cursor:pointer;
    }

    .suggestion-card:hover{ background:#eef3ff; }

    .suggestion-title{ font-weight:bold; }
    .suggestion-city{ font-size:12px; color:#555; }

    /* üß≠ Bot√µes flutuantes */
    .map-actions{
      position:absolute;
      right:16px;
      bottom:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:1000;
    }

    .map-btn{
      background:white;
      border:1px solid #003c8d;
      color:#003c8d;
      padding:10px 12px;
      border-radius:10px;
      font-size:13px;
      cursor:pointer;
      box-shadow:0 3px 8px rgba(0,0,0,.2);
    }

    .map-btn.active{
      background:#003c8d;
      color:white;
    }

    .leaflet-popup-content{
      max-width:260px;
      max-height:60vh;
      overflow-y:auto;
    }

    .popup-title{ font-weight:bold; color:#003c8d; margin-bottom:6px; }
    .popup-address{ font-size:12px; margin-bottom:10px; }

    .popup-actions{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .popup-btn{
      width:100%;
      padding:8px;
      border-radius:8px;
      border:1px solid #003c8d;
      background:#003c8d;
      color:white;
      font-size:13px;
      cursor:pointer;
    }

    .popup-btn.secondary{
      background:white;
      color:#003c8d;
    }
  </style>

</head>

<body>

<script>
document.addEventListener("DOMContentLoaded", async ()=>{
  await Clerk.load();
  if(!Clerk.user) return location.href="/signin.html";
  document.body.style.display="block";
  initMapa();
});
</script>

<header>
  <h2 style="margin:0;">Mapa</h2>
  <button onclick="location.href='app.html'">‚Üê Voltar</button>
</header>

<div class="search-box">
  <input id="search" placeholder="Buscar posto, cidade ou bairro‚Ä¶" autocomplete="off">
  <div id="suggestions"></div>
</div>

<div style="position:relative">
  <div id="map"></div>

  <div class="map-actions">
    <button id="btnGps" class="map-btn">üìç Minha localiza√ß√£o</button>
    <button id="btnRota" class="map-btn">üß≠ Ver somente rota</button>
  </div>
</div>

<script>
async function initMapa(){

  const map = L.map("map",{ zoomControl:false }).setView([-22.905,-47.060],10);

  L.control.zoom({ position:'topright' }).addTo(map);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  const postos = await fetch("/api/postos").then(r=>r.json());
  const markers = [];

  const zonas = [...new Set(postos.map(p=>p.ZONA).filter(Boolean))];
  const cores = {};
  zonas.forEach((z,i)=>cores[z]=`hsl(${(i*360)/zonas.length},70%,45%)`);

  function icon(cor,ativo=false){
    return L.divIcon({
      html:`<div style="background:${cor};width:${ativo?18:12}px;height:${ativo?18:12}px;border-radius:50%;opacity:${ativo?1:0.6};border:2px solid white"></div>`
    });
  }

  postos.forEach((p,i)=>{
    if(!p.Latitude||!p.Longitude) return;

    const endereco=[p["ENDERE√áO I"],p["ENDERE√áO II"],p["ENDERE√áO III"],p["ENDERE√áO IV"],p.CIDADE].filter(Boolean).join(" - ");

    const popup=`
      <div>
        <div class="popup-title">${p["POSTOS DE SERVI√áOS / GRUPO SETER"]}</div>
        <div class="popup-address">${endereco}</div>
        <div class="popup-actions">
          <button class="popup-btn" onclick="addRota(${i})">‚ûï Incluir na rota</button>
        </div>
      </div>
    `;

    const m=L.marker([p.Latitude,p.Longitude],{icon:icon(cores[p.ZONA]||"#555")})
      .addTo(map).bindPopup(popup);

    markers.push({marker:m,posto:p,index:i});
  });

  // üìç GPS
  document.getElementById("btnGps").onclick=()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      const latlng=[pos.coords.latitude,pos.coords.longitude];
      map.setView(latlng,15);
      L.circleMarker(latlng,{radius:8,color:"#1976d2"}).addTo(map);
    });
  };

  // üß≠ ROTA
  let somenteRota=false;
  document.getElementById("btnRota").onclick=function(){
    somenteRota=!somenteRota;
    this.classList.toggle("active",somenteRota);

    const rota=(JSON.parse(localStorage.getItem("rota_postos")||"{}").rota)||[];

    markers.forEach(m=>{
      const existe=rota.some(r=>r.Latitude==m.posto.Latitude&&r.Longitude==m.posto.Longitude);
      if(!somenteRota||existe) m.marker.addTo(map);
      else map.removeLayer(m.marker);
    });
  };

  // üîç BUSCA
  const search=document.getElementById("search");
  const suggestions=document.getElementById("suggestions");

  search.addEventListener("input",()=>{
    const q=search.value.toLowerCase();
    suggestions.innerHTML="";
    if(!q) return;

    postos.filter(p=>
      p["POSTOS DE SERVI√áOS / GRUPO SETER"]?.toLowerCase().includes(q)||
      p.CIDADE?.toLowerCase().includes(q)||
      p["ENDERE√áO III"]?.toLowerCase().includes(q)
    ).slice(0,10).forEach(p=>{
      const i=postos.indexOf(p);
      const div=document.createElement("div");
      div.className="suggestion-card";
      div.innerHTML=`<div class="suggestion-title">${p["POSTOS DE SERVI√áOS / GRUPO SETER"]}</div>
                     <div class="suggestion-city">${p.CIDADE} ‚Äî ${p["ENDERE√áO III"]||""}</div>`;
      div.onclick=()=>{
        const obj=markers.find(m=>m.index===i);
        map.setView(obj.marker.getLatLng(),14);
        obj.marker.openPopup();
        suggestions.innerHTML="";
      };
      suggestions.appendChild(div);
    });
  });
}

function addRota(i){
  fetch("/api/postos").then(r=>r.json()).then(postos=>{
    const dados=JSON.parse(localStorage.getItem("rota_postos")||"{}");
    const rota=dados.rota||[];
    rota.push({...postos[i]});
    localStorage.setItem("rota_postos",JSON.stringify({rota,data:new Date().toLocaleString("pt-BR")}));
    alert("Posto adicionado √† rota!");
  });
}
</script>

</body>
</html>
