<!DOCTYPE html>
<html lang="pt-BR">
<head>

  <!-- üî• Anti-cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Mapa ‚Äî Postos UNISETER</title>

  <!-- üîê Clerk -->
  <script async crossorigin="anonymous"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
    data-clerk-publishable-key="pk_test_bHVja3ktc3RpbmtidWctODUuY2xlcmsuYWNjb3VudHMuZGV2JA">
  </script>

  <!-- üé® CSS global -->
  <link rel="stylesheet" href="style.css?v=202501">

  <!-- üó∫Ô∏è Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body{ display:none; padding:20px; }

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }

    #map{
      width:100%;
      height:calc(100vh - 200px);
      border-radius:12px;
      border:1px solid var(--border);
    }

    .search-box{
      max-width:520px;
      margin:0 auto 12px;
      position:relative;
    }

    #search{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:2px solid #003c8d;
      font-size:15px;
    }

    #suggestions{
      position:absolute;
      width:100%;
      background:white;
      border-radius:8px;
      box-shadow:0 4px 10px rgba(0,0,0,.15);
      z-index:1000;
      max-height:260px;
      overflow:auto;
    }

    .suggestion-card{
      padding:8px 10px;
      cursor:pointer;
    }

    .suggestion-card:hover,
    .suggestion-card.active{
      background:#eef3ff;
    }

    .suggestion-title{ font-weight:bold; }
    .suggestion-city{ font-size:12px; color:#555; }

    button{
      padding:8px 14px;
      border-radius:8px;
      border:1px solid var(--border);
      cursor:pointer;
    }
  </style>

</head>

<body>

<script>
document.addEventListener("DOMContentLoaded", async ()=>{
  await Clerk.load();
  if(!Clerk.user) return location.href="/signin.html";
  document.body.style.display="block";
  initMapa();
});
</script>

<header>
  <h2 style="margin:0;">Mapa</h2>
  <button onclick="location.href='app.html'">‚Üê Voltar</button>
</header>

<div class="search-box">
  <input id="search" placeholder="Buscar posto, cidade ou bairro‚Ä¶">
  <div id="suggestions"></div>
</div>

<div id="map"></div>

<script>
async function initMapa(){

  const map = L.map("map").setView([-22.905, -47.060], 10);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution:"&copy; OpenStreetMap"
  }).addTo(map);

  const postos = await fetch("/api/postos").then(r=>r.json());
  const markers = [];

  // üé® cores din√¢micas
  const zonas = [...new Set(postos.map(p=>p.ZONA).filter(Boolean))];
  const cores = {};
  zonas.forEach((z,i)=>{
    cores[z] = `hsl(${(i*360)/zonas.length},70%,45%)`;
  });

  function icon(cor, ativo=false){
    return L.divIcon({
      html:`<div style="
        background:${cor};
        width:${ativo?18:12}px;
        height:${ativo?18:12}px;
        border-radius:50%;
        opacity:${ativo?1:0.45};
        border:2px solid white;
      "></div>`
    });
  }

  postos.forEach((p,i)=>{
    if(!p.Latitude || !p.Longitude) return;

    const endereco = [
      p["ENDERE√áO I"],p["ENDERE√áO II"],p["ENDERE√áO III"],p["ENDERE√áO IV"],p.CIDADE
    ].filter(Boolean).join(" - ");

    const popup = `
      <b>${p["POSTOS DE SERVI√áOS / GRUPO SETER"]}</b><br>
      <small>${endereco}</small><br><br>
      <button onclick="addRota(${i})">‚ûï Incluir na rota</button><br><br>
      <a href="https://www.google.com/maps/search/?api=1&query=${p.Latitude},${p.Longitude}" target="_blank">üìç Google Maps</a><br>
      <a href="https://waze.com/ul?ll=${p.Latitude},${p.Longitude}&navigate=yes" target="_blank">üöó Waze</a>
    `;

    const m = L.marker(
      [p.Latitude,p.Longitude],
      { icon: icon(cores[p.ZONA]||"#555") }
    ).addTo(map).bindPopup(popup);

    markers.push({ marker:m, posto:p, index:i });
  });

  // üîç BUSCA COM SUGEST√ïES (MESMA L√ìGICA DO APP)
  const search = document.getElementById("search");
  const suggestions = document.getElementById("suggestions");
  let active = -1;

  search.addEventListener("input", ()=>{
    const q = search.value.toLowerCase();
    suggestions.innerHTML="";
    active=-1;
    if(!q) return;

    const lista = postos.filter(p =>
      p["POSTOS DE SERVI√áOS / GRUPO SETER"]?.toLowerCase().includes(q) ||
      p.CIDADE?.toLowerCase().includes(q) ||
      p["ENDERE√áO III"]?.toLowerCase().includes(q)
    ).slice(0,10);

    suggestions.innerHTML = lista.map(p=>{
      const i = postos.indexOf(p);
      return `
        <div class="suggestion-card" data-i="${i}">
          <div class="suggestion-title">${p["POSTOS DE SERVI√áOS / GRUPO SETER"]}</div>
          <div class="suggestion-city">${p.CIDADE} ‚Äî ${p["ENDERE√áO III"]||""}</div>
        </div>
      `;
    }).join("");

    document.querySelectorAll(".suggestion-card").forEach(el=>{
      el.onclick=()=>{
        const i=+el.dataset.i;
        const obj = markers.find(m=>m.index===i);

        markers.forEach(m=>m.marker.setIcon(icon(cores[m.posto.ZONA]||"#555")));
        obj.marker.setIcon(icon(cores[obj.posto.ZONA]||"#555",true));
        map.setView(obj.marker.getLatLng(),14);
        obj.marker.openPopup();
        suggestions.innerHTML="";
      };
    });
  });
}

function addRota(i){
  fetch("/api/postos")
    .then(r=>r.json())
    .then(postos=>{
      const dados = JSON.parse(localStorage.getItem("rota_postos")||"{}");
      const rota = dados.rota || [];
      rota.push({...postos[i]});
      localStorage.setItem("rota_postos",JSON.stringify({
        rota,
        data:new Date().toLocaleString("pt-BR")
      }));
      alert("Posto adicionado √† rota!");
    });
}
</script>

</body>
</html>
